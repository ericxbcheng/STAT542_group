---
title: 'STAT 542 Group Project: Skin Cancer Classification'
author: "Xianbin Cheng"
date: "December 1, 2019"
output: pdf_document
---

```{r, warning = FALSE, message = FALSE, echo = FALSE}
library(tidyverse)
library(imager)
library(imagerExtra)
```

```{r}
# files_benign = dir(path = "D:/STAT542/benign", full.names = TRUE)
# files_malignant = dir(path = "D:/STAT542/malignant", full.names = TRUE)

# files_benign = dir(path = "C:/Work/STAT542/benign", full.names = TRUE)
# files_malignant = dir(path = "C:/Work/STAT542/malignant", full.names = TRUE)

files_benign = dir(path = "D:/STAT542/benign", full.names = TRUE)
files_malignant = dir(path = "D:/STAT542/malignant", full.names = TRUE)
```

```{r}
# Cropping and resizing
my_crop = function(im, length, width){
  
  im_length = dim(im)[1]
  im_width = dim(im)[2]
  
  if(im_length == length & im_width == width){
    return(im)
  } else {
    if(im_length/im_width != length/width){
      
      im_length2 = length/width * im_width
      im2 = crop.borders(im = im, nx = (im_length - im_length2)/2)
      im3 = resize(im = im2, size_x = length, size_y = width, interpolation_type = 3)
      return(im3)
      
    } else {
      im2 = resize(im = im, size_x = length, size_y = width)
      return(im2)
    }
  }
}
```

```{r}
# # imager
# images_b = map(.x = files_benign, .f = load.image)
# images_m = map(.x = files_malignant, .f = load.image)
test = load.image(str_subset(string = files_benign, pattern = "0104"))
test
plot(test)
```

```{r}
rm_border = function(im, thresh_black, thresh_perc_x, thresh_perc_y){
  
  # Find out which pixels are black
  bool_black = grayscale(im) < thresh_black
  
  # Calculate how many black pixels per row/column. If the proportion of black pixels in a row/column exceeds thresh_perc, remove that row/column
  rm_pix_x = rowMeans(bool_black) > thresh_perc_x
  rm_pix_y = colMeans(bool_black) > thresh_perc_y
  return(crop.borders(im = im, nx = sum(rm_pix_x) / 2, ny = sum(rm_pix_y) / 2))
}

test2 = rm_border(im = test, thresh_black = 0.1, thresh_perc_x = 0.6, thresh_perc_y = 0.3) %>% plot()
```

```{r}
# Hair and ruler removal
test3 = dilate_square(im = test2, size = 7) %>% plot()
```

```{r}
# Bubble removal
test4 = medianblur(im = test3, n = 30) %>% plot()
test4
```


```{r}
test5 = my_crop(im = test4, length = 600, width = 450)
plot(test5)
```

```{r}
# Size measurement / edge detection
iiply(im = test5, axis = "c", fun = threshold, thr = 0.4) %>% plot()
```


```{r}
# histogram equalization
hist.eq = function(im){
  as.cimg(obj = ecdf(x = im)(im), dim = dim(im))
}

iiply(im = test2, axis = "c", fun = hist.eq) %>% plot()
iiply(im = test2, axis = "c", fun = BalanceSimplest, sleft = 1, sright = 1, range = c(0,1)) %>% plot()
iiply(im = test2, axis = "c", fun = EqualizePiecewise, N = 10, smax = 1, range = c(0,1)) %>% plot()
iiply(im = test2, axis = "c", fun = SPE, lamda = 0.1, range = c(0,1)) %>% plot()
iiply(im = test2, axis = "c", fun = EqualizeDP, t_down = 1, t_up = 1000, range = c(0,1)) %>% plot()
iiply(im = test2, axis = "c", fun = EqualizeADP, range = c(0,1)) %>% plot()
```

```{r}
# pix to matrix
pix2vec = function(im){
  c(as.vector(R(im)), as.vector(G(im)), as.vector(B(im)))
}

test6 = pix2vec(im = test5)
```

```{r}
# Preprocessing
for(i in 1:length(files_malignant)){
  
  load.image(file = files_malignant[i]) %>%
      rm_border(im = ., thresh_black = 0.1, thresh_perc_x = 0.2, thresh_perc_y = 0.5) %>%
      my_crop(im = ., length = 300, width = 225) %>%
      dilate_square(im = ., size = 3) %>%
      medianblur(im = ., n = 5) %>%
      save.image(im = ., file = paste0("D:/STAT542/my_malignant/","malignant", i, ".jpeg"))
  
}
```


